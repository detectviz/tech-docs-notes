# éƒ¨ç½²å¸¶æœ‰ä½¿ç”¨è€…ä»‹é¢çš„æ‡‰ç”¨

æœ¬æŒ‡å—æ¶µè“‹å°‡å¸¶æœ‰ UI çš„ä»£ç†æ‡‰ç”¨ç¨‹å¼éƒ¨ç½²åˆ° Google Cloud çš„ç­–ç•¥ï¼Œé‡é»é—œæ³¨é–‹ç™¼ã€æ¸¬è©¦å’Œç¤ºç¯„çš„æ–¹æ³•ã€‚

### 1. éƒ¨ç½²ç­–ç•¥

åœ¨éƒ¨ç½²åŒæ™‚åŒ…å«å¾Œç«¯å’Œå‰ç«¯ UI çš„æ‡‰ç”¨ç¨‹å¼æ™‚ï¼Œå­˜åœ¨å…©ç¨®ä¸»è¦ç­–ç•¥ã€‚

#### A. çµ±ä¸€ä¸€éƒ¨ç½²
*   **æè¿°**ï¼šå¾Œç«¯å’Œå‰ç«¯è¢«æ‰“åŒ…ä¸¦å¾å–®ä¸€ã€çµ±ä¸€çš„æœå‹™ä¸­æä¾›ã€‚
*   **æœ€é©ç”¨æ–¼**ï¼šé€™ç¨®æ–¹æ³•æ›´ç°¡å–®ï¼Œéå¸¸é©åˆ**é–‹ç™¼å’Œæ¸¬è©¦ç›®çš„**ã€‚
*   **æŠ€è¡“**ï¼šGoogle Cloud Run æ”¯æ´æ­¤æ¨¡å‹ï¼Œä¸¦å¯é€éå–®ä¸€çš„ [Identity-Aware Proxy (IAP)](https://cloud.google.com/run/docs/securing/identity-aware-proxy-cloud-run) ç«¯é»ä¾†ä¿è­·å®ƒã€‚

#### B. è§£è€¦éƒ¨ç½²
*   **æè¿°**ï¼šå¾Œç«¯å’Œå‰ç«¯ä½œç‚ºç¨ç«‹çš„æœå‹™é‹è¡Œã€‚
*   **æœ€é©ç”¨æ–¼**ï¼šé€™æ˜¯ä¸€ç¨®æ›´ç©©å¥ã€**é¢å‘ç”Ÿç”¢**çš„æ¶æ§‹ã€‚
*   **ä½¿ç”¨æ™‚æ©Ÿ**ï¼šå¦‚æœæ‚¨çš„å¾Œç«¯æŠ€è¡“ä¸é©åˆæä¾› Web å‰ç«¯ (ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨å°ˆç”¨çš„ `Agent Engine`)ï¼Œå‰‡æœ‰å¿…è¦æ¡ç”¨æ­¤æ–¹æ³•ã€‚åœ¨é€™ç¨®æƒ…æ³ä¸‹ï¼Œå‰ç«¯æœƒè¢«å–®ç¨éƒ¨ç½²åˆ°å¦ä¸€å€‹ Cloud Run æœå‹™æˆ– Cloud Storageã€‚

::: tip æ³¨æ„
æœ¬æŒ‡å—å°ˆæ³¨æ–¼ä½¿ç”¨ Google Cloud Run çš„**çµ±ä¸€ä¸€éƒ¨ç½²**ç­–ç•¥ï¼Œé€™å°æ–¼å¿«é€Ÿé–‹ç™¼å’Œå…§éƒ¨æ¸¬è©¦æ˜¯ç†æƒ³çš„ã€‚
:::

### 2. ä½¿ç”¨ IAP éƒ¨ç½²åˆ° Cloud Run

éƒ¨ç½²æ–¹æ³•å–æ±ºæ–¼æ‚¨æ˜¯ä½¿ç”¨æ¡†æ¶å…§å»ºçš„ UI é‚„æ˜¯è‡ªè¨‚çš„ UIã€‚

#### A. æƒ…å¢ƒ 1ï¼šå…§å»ºæ¡†æ¶ UI
è¨±å¤šä»£ç†æ¡†æ¶ (å¦‚ ADK) åŒ…å«ä¸€å€‹å…§å»ºçš„ Web UI æˆ–ã€ŒéŠæ¨‚å ´ã€([`adk-web`](https://github.com/google/adk-web))ï¼Œé è¨­æƒ…æ³ä¸‹èˆ‡å¾Œç«¯ API ä¸€èµ·æä¾›ã€‚é€™å°æ–¼å¿«é€Ÿå°‡æœå‹™æä¾›çµ¦å…¶ä»–é–‹ç™¼äººå“¡æˆ–æ¸¬è©¦äººå“¡éå¸¸æœ‰ç”¨ã€‚

**i. éƒ¨ç½²æœå‹™ï¼š**
å°è¦½è‡³æ‚¨å°ˆæ¡ˆçš„æ ¹ç›®éŒ„ä¸¦åŸ·è¡Œé å…ˆè¨­å®šçš„ `make` æŒ‡ä»¤ï¼š
```bash
make backend IAP=true
```
é€™å€‹å–®ä¸€æŒ‡ä»¤é€šå¸¸æœƒè™•ç†å»ºç½®å®¹å™¨ã€å°‡å…¶æ¨é€åˆ°è¨»å†Šä¸­å¿ƒã€éƒ¨ç½²åˆ° Cloud Run ä»¥åŠè¨­å®š IAPã€‚

#### B. æƒ…å¢ƒ 2ï¼šè‡ªè¨‚å‰ç«¯
å¦‚æœæ‚¨æœ‰ä¸€å€‹ç¨ç«‹çš„è‡ªè¨‚å‰ç«¯ (ä¾‹å¦‚ï¼Œç”¨æ–¼ `gemini_fullstack` ä»£ç†æˆ– `live_api` çš„ React æ‡‰ç”¨ç¨‹å¼)ï¼Œä¸¦å¸Œæœ›å°‡å…¶èˆ‡å¾Œç«¯ä¸€èµ·éƒ¨ç½²ä»¥é€²è¡Œæ¸¬è©¦ï¼Œå‰‡è©²éç¨‹éœ€è¦è‡ªè¨‚å®¹å™¨è¨­å®šã€‚

**ç­–ç•¥**ï¼šç‚ºäº†é–‹ç™¼ï¼Œä¿®æ”¹ `Dockerfile` ä»¥åœ¨å–®ä¸€å®¹å™¨å…§å»ºç½®ä¸¦åŸ·è¡Œå‰ç«¯çš„é–‹ç™¼ä¼ºæœå™¨å’Œå¾Œç«¯çš„ API ä¼ºæœå™¨ã€‚

> **é‡è¦æç¤ºï¼š** é€™ç¨®æ–¹æ³•ï¼Œç‰¹åˆ¥æ˜¯é‹è¡Œåƒ `npm run dev` é€™æ¨£çš„å‰ç«¯é–‹ç™¼ä¼ºæœå™¨ï¼Œåƒ…é©ç”¨æ–¼**é–‹ç™¼å’Œæ¸¬è©¦ç›®çš„**ã€‚å°æ–¼ç”Ÿç”¢ç’°å¢ƒï¼Œæ‚¨æ‡‰è©²å»ºç½®éœæ…‹å‰ç«¯è³‡ç”¢ä¸¦æœ‰æ•ˆåœ°æä¾›å®ƒå€‘ã€‚

**i. è¨­å®š Dockerfileï¼š**
å»ºç«‹æˆ–ä¿®æ”¹æ‚¨çš„ `Dockerfile` ä»¥å®‰è£ Python å’Œ Node.js çš„ä¾è³´é …ï¼Œä¸¦åŒæ™‚å•Ÿå‹•å…©å€‹æœå‹™ã€‚

::: details ç”¨æ–¼çµ„åˆå¾Œç«¯å’Œå‰ç«¯çš„ Dockerfile ç¯„ä¾‹
```dockerfile
FROM python:3.11-slim

# å®‰è£ Node.js å’Œ npm
RUN apt-get update && apt-get install -y \
    nodejs \
    npm \
    curl \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

RUN pip install --no-cache-dir uv==0.6.12

WORKDIR /code

# è¤‡è£½å¾Œç«¯æª”æ¡ˆ
COPY ./pyproject.toml ./README.md ./uv.lock* ./
COPY ./app ./app

# è¤‡è£½å‰ç«¯æª”æ¡ˆ
COPY ./frontend ./frontend

# å®‰è£ä¾è³´é …
RUN uv sync --frozen && npm --prefix frontend install

EXPOSE 8000 5173

# ä¸¦è¡Œå•Ÿå‹•å¾Œç«¯å’Œå‰ç«¯
CMD ["sh", "-c", "ALLOW_ORIGINS='*' uv run uvicorn app.server:app --host 0.0.0.0 --port 8000 & npm --prefix frontend run dev -- --host 0.0.0.0 & wait"]
```
:::


**ii. ğŸš€ éƒ¨ç½²çµ„åˆæœå‹™ï¼š**
éƒ¨ç½²æ™‚ï¼Œæ‚¨å¿…é ˆæŒ‡ç¤º Cloud Run å°‡æµé‡å°å‘**å‰ç«¯çš„é€£æ¥åŸ **ã€‚å°‡ `PORT` è®Šæ•¸å‚³éçµ¦æ‚¨çš„ `make` æŒ‡ä»¤ã€‚å¦‚æœæ‚¨çš„å‰ç«¯åœ¨é€£æ¥åŸ  `5173` ä¸Šé‹è¡Œï¼Œå¦‚ç¯„ä¾‹æ‰€ç¤ºï¼š
```bash
make backend IAP=true PORT=5173
```
é€™å¯ç¢ºä¿å— IAP ä¿è­·çš„å…¬é–‹ URL æä¾›æ‚¨çš„ä½¿ç”¨è€…ä»‹é¢ã€‚

### 3. ç®¡ç†ä½¿ç”¨è€…å­˜å–
éƒ¨ç½²å¾Œï¼Œæ‚¨çš„ Cloud Run æœå‹™å—åˆ° IAP çš„ä¿è­·ï¼Œä½†å°šç„¡ä½¿ç”¨è€…è¢«æˆæ¬Šå­˜å–ã€‚æ‚¨å¿…é ˆå°‡ã€ŒhttpsResourceAccessorã€è§’è‰²æˆäºˆé©ç•¶çš„ä½¿ç”¨è€…æˆ– Google ç¾¤çµ„ã€‚

â¡ï¸ éµå¾ªå®˜æ–¹ Google Cloud æ–‡ä»¶ä¾†ç®¡ç†æ‚¨æœå‹™çš„å­˜å–æ¬Šé™ï¼š[ç®¡ç†ä½¿ç”¨è€…æˆ–ç¾¤çµ„å­˜å–](https://cloud.google.com/run/docs/securing/identity-aware-proxy-cloud-run#manage_user_or_group_access)ã€‚
