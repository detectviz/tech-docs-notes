---
id: migrate-11_6_x-to-12_0_x
title: 11.6.x 至 12.0.x
sidebar_position: 1
description: 如何將插件從 Grafana 11.6.x 版遷移至 12.0.x 版。
keywords:
  - grafana
  - plugins
  - plugin
  - upgrading
  - updating
  - migration
---

# 將插件從 Grafana 11.6.x 版遷移至 12.0.x 版

本指南協助您將插件從 Grafana 11.6.x 版遷移至 12.0.x 版。

## 先決條件

在開始遷移之前：

- 備份您的插件程式碼
- 確保您的開發環境是最新的
- 熟悉 Grafana 11.4 中引入的[反應式 API](/how-to-guides/ui-extensions/)

## 已棄用的 UI 擴充功能 API 移除

在 Grafana 12 中，已棄用的 UI 擴充功能 API 已被移除，取而代之的是 Grafana 11.4 中引入的新的反應式 API。以下 API 已被移除：

- `usePluginExtensions()`
- `usePluginLinkExtensions()`
- `usePluginComponentExtensions()`
- `getPluginExtensions()`
- `getPluginLinkExtensions()`
- `getPluginComponentExtensions()`
- `AppPlugin.configureExtensionLink()`
- `AppPlugin.configureExtensionComponent()`

在 Grafana 12 中使用任何這些 API 都會導致錯誤。此外，TypeScript 類型 `PluginExtensionLinkConfig` 和 `PluginExtensionComponentConfig` 已被移除。

:::info
如果您需要您的插件同時適用於 Grafana 12.0.x 和舊版，您可以實作執行階段檢查以有條件地使用適當的 API。有關更多資訊，請參閱[使用執行階段檢查管理向後相容性](/how-to-guides/runtime-checks.md#example-conditionally-use-react-hooks)。
:::

### AppPlugin.configureExtensionLink()

將 `configureExtensionLink` 方法替換為 `addLink` 方法。將 `extensionPointId` 參數更新為 `targets`，它接受 `string` 或 `string[]`。

```diff
- new AppPlugin().configureExtensionLink({
+ new AppPlugin().addLink({
- extensionPointId: PluginExtensionPoints.DashboardPanelMenu,
+ targets: PluginExtensionPoints.DashboardPanelMenu,
    title: 'Component title 0',
    description: 'Component description 0',
    component: () => <div />,
});
```

### AppPlugin.configureExtensionComponent()

將 `configureExtensionComponent` 方法替換為 `addComponent` 方法。將 `extensionPointId` 參數更新為 `targets`，它接受 `string` 或 `string[]`。

```diff
- new AppPlugin().configureExtensionComponent({
+ new AppPlugin().addComponent({
- extensionPointId: PluginExtensionPoints.CommandPalette,
+ targets: PluginExtensionPoints.CommandPalette,
    title: 'Component title 0',
    description: 'Component description 0',
    component: () => <div />,
});
```

### getPluginLinkExtensions() and usePluginLinkExtensions()

`getPluginLinkExtensions()` 函式和 `usePluginLinkExtensions()` React hook 都可以用 `usePluginLinks()` React hook 取代。

```diff title="getPluginLinkExtensions"
- const { extensions } = getPluginLinkExtensions({
+ const { links, isLoading } = usePluginLinks({
    extensionPointId: 'grafana/dashboard/panel/menu/v1',
    limitPerPlugin: 2,
    context: {
      panelId: '...',
    },
});
```

```diff title="usePluginLinkExtensions"
- const { extensions, isLoading } = usePluginLinkExtensions({
+ const { links, isLoading } = usePluginLinks({
    extensionPointId: 'grafana/dashboard/panel/menu/v1',
    limitPerPlugin: 2,
    context: {
      panelId: '...',
    },
});
```

### getPluginComponentExtensions() and usePluginComponentExtensions()

您可以用 `usePluginComponents()` React hook 取代 `getPluginComponentExtensions()` 函式和 `usePluginComponentExtensions()` React hook。

```diff title="getPluginComponentExtensions"
- const { extensions } = getPluginComponentExtensions({
+ const { components, isLoading } = usePluginComponents({
    extensionPointId: 'grafana/user/profile/tab/v1',
    limitPerPlugin: 2,
});
```

```diff title="usePluginComponentExtensions"
- const { extensions, isLoading } = usePluginComponentExtensions({
+ const { components, isLoading } = usePluginComponents({
    extensionPointId: 'grafana/user/profile/tab/v1',
    limitPerPlugin: 2,
});
```

### getPluginExtensions() and usePluginExtensions()

根據其用法取代 `getPluginExtensions()` 函式和 `usePluginExtensions()` React hook：

- **對於連結：** 遵循[連結擴充功能](https://github.com/grafana/plugin-tools/pull/1639/files#getpluginlinkextensions-and-usepluginlinkextensions)的說明。

- **對於元件：** 遵循[元件擴充功能](https://github.com/grafana/plugin-tools/pull/1639/files#getplugincomponentextensions-and-useplugincomponentextensions)的說明。

- **對於連結和元件：** 同時使用 `usePluginLinks` 和 `usePluginComponents`。

### PluginExtensionLinkConfig and PluginExtensionComponentConfig

`@grafana/data` 中的 `PluginExtensionLinkConfig` 和 `PluginExtensionComponentConfig` 類型已被移除。請分別用 `PluginExtensionAddedLinkConfig` 和 `PluginExtensionAddedComponentConfig` 取代它們。

### GetPluginExtensionsOptions

`@grafana/runtime` 中的 `GetPluginExtensionsOptions` 類型已被移除，取而代之的是符合其對應 hook 參數的特定類型。

## 快速參考

下表總結了 API 變更，並附有說明關鍵差異的註解：

| 已棄用的 API | 對等的 API | 註解 |
| --- | --- | --- |
| `AppPlugin.configureExtensionLink()` | `AppPlugin.addLink()` | `extensionPointId` 參數重新命名為 `targets`，接受 `string` 或 `string[]` |
| `AppPlugin.configureExtensionComponent()` | `AppPlugin.addComponent()` | `extensionPointId` 參數重新命名為 `targets`，接受 `string` 或 `string[]` |
| `getPluginLinkExtensions()` | `usePluginLinks()` | 傳回 `{ links, isLoading }` 而非 `{ extensions }` |
| `usePluginLinkExtensions()` | `usePluginLinks()` | 傳回 `{ links, isLoading }` 而非 `{ extensions }` |
| `getPluginComponentExtensions()` | `usePluginComponents()` | 傳回 `{ components, isLoading }` 而非 `{ extensions }` |
| `usePluginComponentExtensions()` | `usePluginComponents()` | 傳回 `{ components, isLoading }` 而非 `{ extensions, isLoading }` |
| `getPluginExtensions()` | `usePluginLinks()` 或 `usePluginComponents()` | 根據擴充功能類型（連結或元件）分割為兩個獨立的 hook |
| `usePluginExtensions()` | `usePluginLinks()` 或 `usePluginComponents()` | 根據擴充功能類型（連結或元件）分割為兩個獨立的 hook |
| `PluginExtensionComponentConfig` | `PluginExtensionAddedComponentConfig` | 元件設定的更新類型定義 |
| `PluginExtensionLinkConfig` | `PluginExtensionAddedLinkConfig` | 連結設定的更新類型定義 |
| `GetPluginExtensionsOptions` | `UsePluginLinksOptions` 或 `UsePluginComponentsOptions` 或 `UsePluginFunctionsOptions` | hook 參數的更新類型定義 |

## 從 `Select` 遷移至 `Combobox`

Grafana 11.5.0 引入了新的 `Combobox` 元件作為 `Select` 元件的替代品。`Combobox` 元件在設計時考慮了效能，特別是為了處理極大的資料集。有關詳細的使用指南，請參閱[元件文件](https://developers.grafana.com/ui/latest/index.html?path=/docs/forms-combobox--docs)。

`Select` 和 `MultiSelect` 元件現已在 Grafana 12 中棄用，將不會收到實質性的更新或修正。我們建議遷移至 `Combobox` 和 `MultiCombobox`。

### 基本用法

對於簡單的使用案例，`Combobox` 元件的 API 與 `Select` 類似。

```tsx
/**
 * 先前的 Select 實作
 */
import { SelectableValue } from '@grafana/data';
import { Select } from '@grafana/ui';

const options: SelectableValue[] = [
  { label: 'Loki', value: 'datasource-loki' },
  { label: 'Prometheus', value: 'datasource-prom' },
];
const [value, setValue] = useState<SelectableValue>();

<Select value={value} options={options} onChange={(newOption) => setValue(newOption)} />;

/**
 * 新的 Combobox 實作
 */
import { Combobox, ComboboxOption } from '@grafana/ui';

const options: ComboboxOption[] = [
  { label: 'Loki', value: 'datasource-loki' },
  { label: 'Prometheus', value: 'datasource-prom' },
];

// 建議僅將選項中的 'value' 屬性傳遞給 value prop
const [value, setValue] = useState<string>();

<Combobox value={value} options={options} onChange={(newOption) => setValue(newOption.value)} />;
```

### 非同步資料載入

`Combobox` 元件透過傳遞給 `options` prop 的函式來處理非同步資料載入。此函式：

- 接收目前的輸入值作為參數
- 傳回一個解析為 `ComboboxOption[]` 的 Promise
- 自動對呼叫進行去抖動以防止過多的 API 請求

```tsx
import { Combobox, ComboboxOption } from '@grafana/ui';

const [value, setValue] = useState<string>();

const loadOptions = useCallback(async (input: string): Promise<ComboboxOption[]> => {
  const response = await fetch(`/api/options?query=${input}`);
  return response.json();
}, []);

<Combobox value={value} options={loadOptions} onChange={(newOption) => setValue(newOption.value)} />;
```

:::warning

請勿在初始開啟時請求_所有_選項。建議僅在呼叫能夠在伺服器端篩選結果的 API 時才使用此非同步行為。

:::

### 快速參考

下表總結了元件棄用的變更，並附有說明關鍵差異的註解：

| 已棄用 | 對等的 | 註解 |
| --- | --- | --- |
| `Select` | `Combobox` | 請參閱下方的 props 表格 |
| `MultiSelect` | `MultiCombobox` | 請參閱下方的 props 表格 |
| `AsyncSelect` | `Combobox` | 為 `options` prop 使用一個非同步函式 |
| `VirtualizedSelect` | `Combobox` | Combobox 預設為虛擬化 |
| `AsyncVirtualizedSelect` | `Combobox` | Combobox 預設為虛擬化 |
| `AsyncMultiSelect` | `MultiSelect` | 為 `options` prop 使用一個非同步函式 |

下表總結了 prop 的變更，並附有說明關鍵差異的註解：

| 已棄用 | 對等的 | 註解 |
| --- | --- | --- |
| `SelectableValue` | `ComboboxOption` | 從 `@grafana/ui` 匯出 |
| `SelectableValue["value"]` | `ComboboxOption["value"]` | 值是必要的，且必須是基本型別 `string \| number` |
| `SelectableValue["description"]` | `ComboboxOption["description"]` | 描述不再被包裝，可能會被截斷 |
| `onChange` | `onChange` | 建議僅在狀態中儲存 `value` |
| `value` | `value` | 建議僅傳入基本型別 `string \| number` 的值 |
| `options` | `options` | 可以是 `ComboboxOption[]` 或傳回 `Promise<ComboboxOption[]>` 的函式 |
| `isLoading` | `loading` | 如果使用非同步選項，則不需要 |
| `allowCustomValue` | `createCustomValue` | 將從 onChange 發出一個像 `{ label: "Foo", value: "Foo" }` 的物件 |
| `width="auto"` | `width="auto"` | 使用自動調整大小的輸入時需要 `minWidth` |

舊版 Select 元件中許多控制細微行為或自訂呈現的 props（例如 `createOptionPosition` 或 `openMenuOnFocus`）已不再支援，以簡化 API 並提供更一致的體驗。如果您有需要此功能的特定使用案例，請在 Grafana 儲存庫中[提出問題](https://github.com/grafana/grafana/issues/new?template=1-feature_requests.md)。