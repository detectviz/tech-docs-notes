---
id: migrate-6_x-to-7_0
title: 6.x 至 7.0
sidebar_position: 11
description: 如何將插件從 Grafana 6.x 版升級至 7.0 版。
keywords:
  - grafana
  - plugins
  - plugin
  - upgrading
  - updating
  - migration
---

# 將插件從 Grafana 6.x 版遷移至 7.0 版

請遵循以下說明，將 Grafana 從 6.x 版升級至 7.0 版。

## Grafana 7.0 的新功能是什麼？

Grafana 7.0 引入了一個全新的基於 React 的插件平台。這個新平台取代了先前基於 Angular 的插件平台。

使用 Angular 建立的插件在短期內仍可運作，但我們強烈建議新的插件作者使用新平台進行開發。

### 新的資料格式

隨著轉向 React，新的插件平台引入了一種名為[資料框架](../../key-concepts/data-frames)的新內部資料格式。

以前，資料來源插件可以以時間序列或表格的形式傳送資料。使用資料框架，資料來源可以以類似表格的結構傳送任何資料。這讓您在 Grafana 中視覺化資料時有更大的靈活性。

### 改進的 TypeScript 支援

雖然先前基於 Angular 的插件 SDK 支援 TypeScript，但我們已大幅改進了對 React 平台的支援。我們所有的 API 現在都以 TypeScript 撰寫，這可能需要現有程式碼更新至新的更嚴格的類型定義。Grafana 7.0 還為插件開發人員引入了幾個新的 API，這些 API 利用了 Grafana 7.0 中的許多新功能。

### Grafana Toolkit

隨著 Grafana 7.0 的發布，我們推出了一個新工具，讓開發插件變得更容易。以前，您會使用 Gulp、Grunt 或類似的工具來產生最小化的資產。Grafana Toolkit 負責建置和測試您的插件，而無需複雜的設定檔。

有關更多資訊，請參閱 [@grafana/toolkit](https://www.npmjs.com/package/@grafana/toolkit)。

:::note

自 Grafana 10.0 起，`@grafana/toolkit` 已被棄用。它已被 [`create-plugin`](../../get-started.md) 工具取代。

:::

### 欄位選項

Grafana 7.0 引入了_欄位選項_的概念，這是一種在視覺化之前設定資料的新方法。由於此功能在先前版本的 Grafana 中不可用，因此任何啟用基於欄位的設定的插件都無法在先前版本的 Grafana 中運作。

對於 Grafana 7.0 之前的插件，所有選項都被視為_顯示選項_。欄位設定的標籤不可用。

### 插件後端元件

雖然插件後端元件在先前版本的 Grafana 中作為實驗性功能提供，但其支援在 Grafana 7 中得到了極大的改進。Grafana 7.0 的插件後端元件向後相容，並將繼續運作。但是，舊的插件後端元件系統已被棄用，我們建議您使用新的 SDK 來開發插件後端元件。

由於 Grafana 7.0 引入了插件簽署，如果社群插件未經簽署，預設情況下將不會載入。

### 遷移至資料框架

在 7.0 之前，資料來源和面板插件使用時間序列或表格來交換資料。從 7.0 開始，插件使用新的資料框架格式將資料從資料來源傳遞給面板。

Grafana 7.0 向後相容於先前版本中使用的舊資料格式。使用舊格式的面板和資料來源仍可與使用新資料框架格式的插件搭配使用。

`query` 方法傳回的 `DataQueryResponse` 可以是 [LegacyResponseData](https://github.com/grafana/grafana/blob/main/packages/grafana-data/src/types/datasource.ts#L419) 或 [DataFrame](https://github.com/grafana/grafana/blob/main/packages/grafana-data/src/types/dataFrame.ts#L200)。

[toDataFrame()](https://github.com/grafana/grafana/blob/main/packages/grafana-data/src/dataframe/processDataFrame.ts#L309) 函式會將舊版回應（例如 `TimeSeries` 或 `Table`）轉換為 `DataFrame`。使用它來逐步將您的程式碼移至新格式。

```ts
import { toDataFrame } from '@grafana/data';
```

```ts
async query(options: DataQueryRequest<MyQuery>): Promise<DataQueryResponse> {
  return {
    data: options.targets.map(query => {
      const timeSeries: TimeSeries = await doLegacyRequest(query);
      return toDataFrame(timeSeries);
    }
  };
}
```

## 插件遷移疑難排解

自 Grafana 7.0 起，插件現在可以進行加密簽署以驗證其來源。預設情況下，Grafana 會忽略未簽署的插件。有關更多資訊，請參閱[允許未簽署的插件](https://grafana.com/docs/grafana/latest/administration/plugin-management#allow-unsigned-plugins)。

## 從 6.5.x 版至 7.3.0 版

請遵循本節中的說明，將 Grafana 從 6.5.x 版升級至 7.3.0 版。

### getColorForTheme 變更

`getColorForTheme` 函式引數已從 `(color: ColorDefinition, theme?: GrafanaThemeType)` 變更為 `(color: string, theme: GrafanaTheme)`。

```ts
// 之前
const color: ColorDefinition = {
  hue: 'green';
  name: 'dark-green';
  variants: {
    light: '#19730E'
    dark: '#37872D'
  };
}
const themeType: GrafanaThemeType = 'dark';
const themeColor = getColorForTheme(color, themeType);

// 之後
const color = 'green';
const theme: GrafanaTheme = useTheme();
const themeColor = getColorForTheme(color, theme);

```

## 從 6.2.x 版至 v7.4.x 版

請遵循本節中的說明，將 Grafana 從 6.2.x 版升級至 v7.4.x 版。

### 圖例元件

圖例元件已重構，並在 `@grafana/ui` 套件中引入了以下變更。

```ts
// 之前
import { LegendItem, LegendOptions, GraphLegend } from '@grafana/ui';

// 之後
import { VizLegendItem, VizLegendOptions, VizLegend } from '@grafana/ui';
```

- `LegendPlacement` 已從 `'under' | 'right' | 'over'` 更新為 `'bottom' | 'right'`，因此您無法再將圖例放置在視覺化上方。
- `LegendItem` 中的 `isVisible` 屬性在 `VizLegendItem` 中已重新命名為 `disabled`。