---
id: migrate-8_x-to-9_x
title: 8.x 至 9.x
sidebar_position: 8
description: 如何將插件從 8.x 版遷移至 9.x 版。
keywords:
  - grafana
  - plugins
  - plugin
  - upgrading
  - updating
  - migration
---

# 將插件從 Grafana 8.x 版遷移至 9.x 版

請遵循以下說明，將插件從 8.x 版遷移至 9.x 版。

## 9.0 破壞性變更

Grafana 9.0 版中引入了以下破壞性變更。

### `theme.visualization.getColorByName` 取代 `getColorForTheme`

`getColorForTheme` 已被移除，因此您應改用 `theme.visualization.getColorByName`。

**範例：**

```ts
// 之前
fillColor: getColorForTheme(panel.sparkline.fillColor, config.theme)

// 之後
fillColor: config.theme.visualization.getColorByName(panel.sparkline.fillColor),
```

### `VizTextDisplayOptions` 取代 `TextDisplayOptions`

`TextDisplayOptions` 已被移除，因此您應改用 `VizTextDisplayOptions`。

**範例：**

```ts
// 之前
interface Options {
...
text?: TextDisplayOptions;
...
}

// 之後
interface Options {
...
text?: VizTextDisplayOptions;
...
}
```

### `backendSrv.fetch()` 內部變更

我們已變更 `backendSrv.fetch()` 的內部結構，當回應為不正確的 JSON 時會擲回錯誤。請務必在使用 `backendSrv.fetch()`（或任何其他 `backendSrv` 方法）的呼叫點處理可能的錯誤。

```ts
// 先前：如果回應是無效的 JSON，則會傳回一個空物件 {}
return await getBackendSrv().post(`${API_ROOT}/${id}/install`);

// 此變更後：如果回應是無效的 JSON，以下將會擲回錯誤
return await getBackendSrv().post(`${API_ROOT}/${id}/install`);
```

### `GrafanaTheme2` 和 `useStyles2` 取代 `getFormStyles`

我們已從 [grafana-ui](https://www.npmjs.com/package/@grafana/ui) 中移除了已棄用的 `getFormStyles` 函式。請改用 `GrafanaTheme2` 和 `useStyles2` hook。

### `/api/ds/query` 取代 `/api/tsdb/query`

我們已移除了已棄用的 `/api/tsdb/query` 指標端點。請改用 [/api/ds/query](https://grafana.com/docs/grafana/latest/developers/http_api/data_source#query-a-data-source)。

### `selectOptionInTest` 已被移除

`@grafana/ui` 套件中用於前端測試的輔助函式 `selectOptionInTest` 已被移除，因為它會導致測試函式庫被捆綁在 Grafana 的生產程式碼中。如果您在測試中使用此輔助函式，請相應地更新您的程式碼：

```ts
// 之前
import { selectOptionInTest } from '@grafana/ui';
// ...測試用法
await selectOptionInTest(selectEl, 'Option 2');

// 之後
import { select } from 'react-select-event';
// ...測試用法
await select(selectEl, 'Option 2', { container: document.body });
```

### Toolkit 9 和 webpack

使用自訂 Webpack 設定的插件可能會因為 webpack@4 和 webpack@5 之間的變更而損壞。請參閱[官方 webpack 遷移指南](https://webpack.js.org/migrate/5/)以取得協助。

Webpack 5 預設不包含 node.js 核心模組的 polyfills（例如，`buffer`、`stream`、`os`）。這可能會導致插件建置失敗。如果需要 polyfills，建議在插件儲存庫的根目錄中建立一個自訂的 webpack 設定，並新增所需的回退：

```js
// webpack.config.js

module.exports.getWebpackConfig = (config, options) => ({
  ...config,
  resolve: {
    ...config.resolve,
    fallback: {
      os: require.resolve('os-browserify/browser'),
      stream: require.resolve('stream-browserify'),
      timers: require.resolve('timers-browserify'),
    },
  },
});
```

有關回退的協助，請參閱 webpack 建置錯誤訊息或[官方遷移指南](https://webpack.js.org/migrate/5/)。