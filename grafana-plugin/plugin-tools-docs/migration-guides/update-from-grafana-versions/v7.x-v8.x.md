---
id: migrate-7_x-to-8_x
title: 7.x 至 8.x
sidebar_position: 10
description: 如何將 Grafana v7.x 插件遷移至 Grafana v8.x 中可用的更新插件系統。
keywords:
  - grafana
  - plugins
  - plugin
  - upgrading
  - updating
  - migration
---

# 將插件從 Grafana 7.x 版遷移至 8.x 版

請遵循以下說明，將 Grafana v7.x.x 插件遷移至 Grafana v8.x.x 中可用的更新插件系統。根據您的插件，您需要執行以下一個或多個步驟。

請注意 Grafana v8.x.x 中的破壞性變更，如下文所述，以及您需要採取哪些步驟來升級您的插件。

## 插件後端 v1 支援已移除

使用新的[插件 Go SDK](../../key-concepts/backend-plugins/grafana-plugin-sdk-for-go) 來執行您在 Grafana 8 中執行的插件後端。

### 1. 新增對 grafana-plugin-sdk-go 的相依性

新增對 `https://github.com/grafana/grafana-plugin-sdk-go` 的相依性。我們建議使用 [Go 模組](https://go.dev/blog/using-go-modules)來管理您的相依性。

### 2. 更新您引導插件的方式

更新您的 `main` 套件，以透過新的插件 Go SDK 進行引導。

```go
// 之前
package main

import (
  "github.com/grafana/grafana_plugin_model/go/datasource"
  hclog "github.com/hashicorp/go-hclog"
  plugin "github.com/hashicorp/go-plugin"

  "github.com/myorgid/datasource/pkg/plugin"
)

func main() {
  pluginLogger.Debug("Running GRPC server")

  ds, err := NewSampleDatasource(pluginLogger);
  if err != nil {
    pluginLogger.Error("Unable to create plugin");
  }

  plugin.Serve(&plugin.ServeConfig{
    HandshakeConfig: plugin.HandshakeConfig{
			ProtocolVersion:  1,
			MagicCookieKey:   "grafana_plugin_type",
			MagicCookieValue: "datasource",
		},
    Plugins: map[string]plugin.Plugin{
			"myorgid-datasource": &datasource.DatasourcePluginImpl{Plugin: ds},
    },
    GRPCServer: plugin.DefaultGRPCServer,
  })
}

// 之後
package main

import (
  "os"

  "github.com/grafana/grafana-plugin-sdk-go/backend/log"
  "github.com/grafana/grafana-plugin-sdk-go/backend/datasource"

  "github.com/myorgid/datasource/pkg/plugin"
)

func main() {
  log.DefaultLogger.Debug("Running GRPC server")

  if err := datasource.Manage("myorgid-datasource", NewSampleDatasource, datasource.ManageOpts{}); err != nil {
				log.DefaultLogger.Error(err.Error())
				os.Exit(1)
		}
}
```

### 3. 更新插件套件

更新您的 `plugin` 套件以使用新的插件 Go SDK：

```go
// 之前
package plugin

import (
  "context"

  "github.com/grafana/grafana_plugin_model/go/datasource"
  "github.com/hashicorp/go-hclog"
)

func NewSampleDatasource(pluginLogger hclog.Logger) (*SampleDatasource, error) {
	return &SampleDatasource{
		logger: pluginLogger,
	}, nil
}

type SampleDatasource struct{
  logger hclog.Logger
}

func (d *SampleDatasource) Query(ctx context.Context, tsdbReq *datasource.DatasourceRequest) (*datasource.DatasourceResponse, error) {
  d.logger.Info("QueryData called", "request", req)
  // 查詢您的資料來源的邏輯。
}

// 之後
package plugin

import (
  "context"

  "github.com/grafana/grafana-plugin-sdk-go/backend"
  "github.com/grafana/grafana-plugin-sdk-go/backend/instancemgmt"
  "github.com/grafana/grafana-plugin-sdk-go/backend/log"
  "github.com/grafana/grafana-plugin-sdk-go/data"
)

func NewSampleDatasource(_ backend.DataSourceInstanceSettings) (instancemgmt.Instance, error) {
	return &SampleDatasource{}, nil
}

type SampleDatasource struct{}


func (d *SampleDatasource) Dispose() {
	// 清理資料來源執行個體資源。
}

func (d *SampleDatasource) QueryData(ctx context.Context, req *backend.QueryDataRequest) (*backend.QueryDataResponse, error) {
  log.DefaultLogger.Info("QueryData called", "request", req)
  // 查詢您的資料來源的邏輯。
}

func (d *SampleDatasource) CheckHealth(_ context.Context, req *backend.CheckHealthRequest) (*backend.CheckHealthResult, error) {
  log.DefaultLogger.Info("CheckHealth called", "request", req)
  // 這些健康狀況檢查的主要使用案例是
  // 資料來源設定頁面上的測試按鈕，它允許使用者驗證
  // 資料來源是否如預期般運作。
}
```

## 簽署和載入具有後端元件的插件

我們強烈建議您不要在您的 Grafana 安裝中允許未簽署的插件。透過允許未簽署的插件，我們無法保證插件的真實性，這可能會危及您 Grafana 安裝的安全性。

若要簽署您的插件，請參閱[簽署插件](../../publish-a-plugin/sign-a-plugin.md)。

您仍然可以透過在[開發模式](https://grafana.com/docs/grafana/latest/administration/configuration/#app_mode)下執行您的 Grafana 執行個體來執行和開發未簽署的插件。或者，您可以使用 [allow_loading_unsigned_plugins](https://grafana.com/docs/grafana/latest/setup-grafana/configure-grafana#allow_loading_unsigned_plugins) 設定。

## 將 react-hook-form 從 v6 更新至 v7

我們已將 react-hook-form 從版本 6 升級至版本 7。若要讓您的表單與版本 7 相容，請參閱 [react-hook-form-migration-guide](https://react-hook-form.com/migrate-v6-to-v7/)。

## 更新 `plugin.json`

定義您的插件支援哪個 Grafana 版本的屬性已重新命名，現在它是一個範圍，而不是一個特定版本。

```json
// 之前
{
"dependencies": {
    "grafanaVersion": "7.5.x",
    "plugins": []
  }
}

// 之後
{
  "dependencies": {
    "grafanaDependency": ">=8.0.0",
    "plugins": []
  }
}
```

## 更新匯入以符合 emotion 11

Grafana 使用 Emotion 函式庫來管理前端樣式。我們已更新 Emotion 套件，如果您有自訂樣式，這可能會影響您的插件前端元件。您只需要更新 `import` 陳述式即可讓它在 Grafana 8 中運作。

```ts
// 之前
import { cx, css } from 'emotion';

// 之後
import { cx, css } from '@emotion/css';
```

## 更新使用儀表板的應用程式插件

為了讓側邊導覽正常運作 - 針對 Grafana `8.+` 並透過 [addToNav](/reference/metadata.md#includes) 屬性整合至側邊選單的應用程式插件需要調整其 `plugin.json` 和所有儀表板 json 檔案以具有相符的 `uid`。

**`plugin.json`**

```json "linenos=inline,hl_lines=7,linenostart=1"
{
  "id": "plugin-id",
  // ...
  "includes": [
    {
      "type": "dashboard",
      "name": "(Team) Situation Overview",
      "path": "dashboards/example-dashboard.json",
      "addToNav": true,
      "defaultNav": false,
      "uid": "l3KqBxCMz"
    }
  ]
  // ...
}
```

**`dashboards/example-dashboard.json`**

```json
{
  // ...
  "title": "Example Dashboard",
  "uid": "l3KqBxCMz",
  "version": 1
  // ...
}
```

## 8.0 棄用

以下功能已在 8.0 版中棄用。

### Grafana 主題 v1

在 Grafana 8 中，我們引入了我們主題系統的新改良版本。先前版本的主題系統仍然可用，但已被棄用，並將在下一個主要版本的 Grafana 中移除。

您可以在[此處](https://github.com/grafana/grafana/blob/main/contribute/style-guides/themes.md#theming-grafana)找到有關如何套用 v2 主題的更詳細資訊。

#### 如何為函式元件設定樣式

`useStyles` hook 是在設定樣式時存取主題的偏好方式。它提供了基本的 memoization 和對主題物件的存取：

```ts
// 之前
import React, { ReactElement } from 'react';
import css from 'emotion';
import { GrafanaTheme } from '@grafana/data';
import { useStyles } from '@grafana/ui';

function Component(): ReactElement | null {
  const styles = useStyles(getStyles);
}

const getStyles = (theme: GrafanaTheme) => ({
  myStyle: css`
    background: ${theme.colors.bodyBg};
    display: flex;
  `,
});

// 之後
import React, { ReactElement } from 'react';
import { css } from '@emotion/css';
import { GrafanaTheme2 } from '@grafana/data';
import { useStyles2 } from '@grafana/ui';

function Component(): ReactElement | null {
  const theme = useStyles2(getStyles);
}

const getStyles = (theme: GrafanaTheme2) => ({
  myStyle: css`
    background: ${theme.colors.background.canvas};
    display: flex;
  `,
});
```

#### 如何在函式元件中使用主題

此範例顯示如何在函式元件中使用主題：

```ts
// 之前
import React, { ReactElement } from 'react';
import { useTheme } from '@grafana/ui';

function Component(): ReactElement | null {
  const theme = useTheme();
}

// 之後
import React, { ReactElement } from 'react';
import { useTheme2 } from '@grafana/ui';

function Component(): ReactElement | null {
  const theme = useTheme2();
  // 您的元件現在可以存取主題變數
}
```

#### 如何在類別元件中使用主題

此範例顯示如何在類別中使用主題：

```ts
// 之前
import React from 'react';
import { Themeable, withTheme } from '@grafana/ui';

type Props = {} & Themeable;

class Component extends React.Component<Props> {
  render() {
    const { theme } = this.props;
    // 您的元件現在可以存取主題變數
  }
}

export default withTheme(Component);

// 之後
import React from 'react';
import { Themeable2, withTheme2 } from '@grafana/ui';

type Props = {} & Themeable2;

class Component extends React.Component<Props> {
  render() {
    const { theme } = this.props;
    // 您的元件現在可以存取主題變數
  }
}

export default withTheme2(Component);
```

## 元件的逐步遷移

如果您需要在相同的上下文中同時使用 v1 和 v2 主題，因為您同時使用了已遷移和未遷移的元件，那麼請在 `v2` 主題上使用 `v1` 屬性。

**範例：**

```ts
function Component(): ReactElement | null {
  const theme = useTheme2();
  return (
    <NonMigrated theme={theme.v1}>
      <Migrated theme={theme] />
    </NonMigrate>
  );
};
```